# Developing `reason-relay` locally

`reason-relay` is made up of these parts:

## Full integration tests

First thing's first - there's a suite of integration tests inside of `/packages/reason-relay/__tests__`. The ambition is that these tests should _cover everything needed to ensure ReasonRelay is working as intended_. This includes the bindings, the language plugin and the PPX - everything. You run them by doing `yarn test` in `/packages/reason-relay`.

Any feature added or fix done should consider whether that case is covered in the integration tests, and add tests for it if possible.

## The ReasonML bindings and utils

`/packages/reason-relay/src` contains all the _ReasonML_ code shipped in the package. You build it by running `yarn bsb -make-world` in `/packages/reason-relay`.

`bsconfig.json` is only used for development, the actual `bsconfig.json` that'll be copied to the published package is located in `bsconfig.release.json`. This setup isn't great and it's likely that we'll move to using the same `bsconfig.json` for dev and release, with a script stripping unwanted things from the config before copying it to the release bundle.

## The PPX

The PPX is located in `/packages/reason-relay/reason-relay-ppx` and is built with `esy`.

The bulk of the PPX is located in `/packages/reason-relay/reason-relay-ppx/library/Util.re`. There's also some tests for the PPX located in `/packages/reason-relay/reason-relay-ppx/test/TestFile.re`.

### Developing the PPX

Ensure you have `esy` installed by running `npm install -g esy`. Go to `/packages/reason-relay/reason-relay-ppx` and run `esy`. This will take some time as it bootstraps and compiles the project. After this finishes, the PPX will be built, and the relevant file will be located at `/packages/reason-relay/reason-relay-ppx/_esy/default/build/default/bin/ReasonRelayPpxApp.exe`.

The PPX is built in Azure for releases. Check out the release section below for details on that.

### Testing with the integration tests

If you want to test your changes to the PPX using the integration tests, run `esy` in the PPX folder to build the PPX, and then run `yarn bsb -clean-world && yarn bsb -make-world && yarn test` in `/packages/reason-relay`. This will clean and rebuild the tests before running them, ensuring that your changes to the PPX is picked up.

## The language plugin for the Relay compiler

This a huge part of what ReasonRelay actually is. The language plugin takes the Flow types generated by the Relay compiler, and translates them to ReasonML types + does a number of other things like generate helpers and what not.

### Developing

It's located in `/packages/reason-relay/language-plugin`, and you build it by doing `yarn build` in that folder. It's part TypeScript, part ReasonML, so for active development of it you'll need to build using both. Most of the things that are regularly changed is in the ReasonML world, so running `yarn bsb -make-world -w` should be enough for most development.

### Tests

The language plugin has a fairly comprehensive test suite that can be run by doing `yarn test`. The tests are sadly mostly snapshot tests, which can make them a bit hard to decipher, but as of now that's the way I felt has given the most "bang for the buck".

### Building

You can build the language plugin in full by running `yarn build` in the root folder of the language plugin. This will build and bundle the plugin.

## Testing with the integration tests

It's a good idea to run the full integration tests after changing the language plugin. You can do that by first building the language plugin as described above, and then run `yarn build:test` in `/packages/reason-relay`. It'll show an error message, _but that's fine_ (and expectd).

Running `yarn build:test` will rerun the Relay compiler for the integration test suite using the newly built plugin. After that runs, you can run `yarn test` in `/packages/reason-relay/` again to run the integration tests with the changes you made.

## Tips & tricks

This will be extended with some tips and tricks for deloping the language plugin at a later point.

## Documentation

The docs are located in `/reason-relay-documentation`. It's built with Docosaurus, and to develop locally you simply do `yarn && yarn start` in that folder. Currently only @zth can do the prod release of this as it's tied to his `now.sh` account, but this may change in the future.

## Release

Doing a release isn't as automated as it should be right now. There's a script called `build-ci.sh` in the root folder which you can run to build the entire project for release (builds into `/_release`), _except_ for the PPX. The PPX is built on Azure for Linux and Mac on push (sadly no Windows right now, but it should be easily fixable as soon as someone asks for it), so in addition to running `./build-ci.sh` you'll need to download the built binaries from [Azure](https://dev.azure.com/gabbenord/reason-relay/_build) and place them in `/_release`, named `ppx-darwin` for Mac and `ppx-linux` for Linux.

Preferably this could be automated fully using GitHub Actions or similar at some point.
